<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeScape - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="vibescapelogo.jpg" type="image/jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        /* ... Your existing CSS is perfect, no changes needed here ... */
        .admin-container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        .admin-header { text-align: center; margin-bottom: 40px; }
        .admin-header h1 { color: var(--primary-color); font-size: 2.5rem; margin-bottom: 10px; }
        .upload-section { background: var(--card-bg-color); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .upload-section h2 { color: var(--text-color); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-color); font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background-color: var(--card-bg-color); color: var(--text-color); font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(227, 0, 136, 0.3); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
        .upload-btn { width: 100%; background: linear-gradient(135deg, var(--primary-color), #b91d97); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(227, 0, 136, 0.4); }
        .upload-btn:disabled { background: #666; cursor: not-allowed; transform: none; }
        .songs-management { background: var(--card-bg-color); border-radius: 15px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .songs-management h2 { color: var(--text-color); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .song-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 15px; background: var(--bg-color); border-radius: 10px; border: 1px solid #333; }
        .song-details h4 { color: var(--text-color); margin-bottom: 5px; }
        .song-details p { color: var(--subtext-color); margin: 2px 0; font-size: 0.9em; }
        .song-actions { display: flex; gap: 10px; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .delete-btn:hover { background: #c82333; }
        .play-btn { background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .play-btn:hover { background: #b91d97; }
        .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600; }
        .success { background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745; }
        .error { background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545; }
        .loading { text-align: center; color: var(--subtext-color); font-style: italic; padding: 20px; }
        .back-link { display: inline-block; margin-top: 20px; color: var(--primary-color); text-decoration: none; font-weight: 600; transition: color 0.3s; }
        .back-link:hover { color: #b91d97; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, var(--primary-color), #b91d97); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <img src="vibescapelogo.jpg" alt="VibeScape Logo" />
            <h2>VibeScape Admin</h2>
        </div>
        <nav class="nav-links">
            <a href="home.html">ðŸŽµ Back to Player</a>
            <a href="home.html">         </a>
            <a href="home.html">         </a>
            <a href="home.html">         </a>
            <a href="home.html">         </a>
        </nav>
        <button id="theme-toggle" class="theme-toggle">
            <i class="fa-solid fa-sun"></i>
        </button>
    </header>

    <div class="admin-container">
        <div class="admin-header">
            <h1>ðŸ”§ Admin Panel</h1>
            <p>Manage your music library</p>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-songs">0</div>
                <div class="stat-label">Total Songs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-artists">0</div>
                <div class="stat-label">Artists</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-genres">0</div>
                <div class="stat-label">Genres</div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2>ðŸ“¤ Upload New Song</h2>
            <div id="message"></div>
            
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group">
                        <label for="title"><i class="fa-solid fa-music"></i> Song Title *</label>
                        <input type="text" id="title" name="title" required placeholder="Enter song title">
                    </div>
                    
                    <div class="form-group">
                        <label for="artist"><i class="fa-solid fa-user"></i> Artist *</label>
                        <input type="text" id="artist" name="artist" required placeholder="Enter artist name">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="genre"><i class="fa-solid fa-tags"></i> Genre</label>
                        <select id="genre" name="genre">
                            <option value="Pop">Pop</option>
                            <option value="Rock">Rock</option>
                            <option value="Hip-Hop">Hip-Hop</option>
                            <option value="Jazz">Jazz</option>
                            <option value="Classical">Classical</option>
                            <option value="Electric">Electric</option>
                            <option value="Bass">Bass</option>
                            <option value="K-Pop">K-Pop</option>
                            <option value="Metal">Metal</option>
                            <option value="Disco">Disco</option>
                            <option value="Melody">Melody</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="emotion"><i class="fa-solid fa-face-smile"></i> Emotion</label>
                        <select id="emotion" name="emotion">
                            <option value="Happy">Happy</option>
                            <option value="Sad">Sad</option>
                            <option value="Angry">Angry</option>
                            <option value="Neutral">Neutral</option>
                            <option value="Surprised">Surprised</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="albumArt"><i class="fa-solid fa-image"></i> Album Art (optional)</label>
                        <input type="file" id="albumArt" name="albumArt" accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label for="artistImage"><i class="fa-solid fa-camera"></i> Artist Image (optional)</label>
                        <input type="file" id="artistImage" name="artistImage" accept="image/*">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="song"><i class="fa-solid fa-file-audio"></i> Audio File *</label>
                    <input type="file" id="song" name="song" accept="audio/*" required>
                </div>
                
                <button type="submit" class="upload-btn" id="uploadBtn">
                    <i class="fa-solid fa-upload"></i> Upload Song
                </button>
            </form>
        </div>

        <!-- Songs Management -->
        <div class="songs-management">
            <h2>ðŸŽµ Manage Songs</h2>
            <div id="songsList">
                <div class="loading">Loading songs...</div>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                document.body.classList.toggle('light-mode');
                const icon = this.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-sun');
                    icon.classList.toggle('fa-moon');
                }
            });
        }

        const uploadForm = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const messageDiv = document.getElementById('message');

        // Show message
        function showMessage(text, type) {
            messageDiv.innerHTML = `<div class="message ${type}"><i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i> ${text}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // Update statistics
        function updateStats(songs) {
            const totalSongs = songs.length;
            const uniqueArtists = [...new Set(songs.map(song => song.artist))].length;
            const uniqueGenres = [...new Set(songs.map(song => song.genre || 'Unknown'))].length;
            document.getElementById('total-songs').textContent = totalSongs;
            document.getElementById('total-artists').textContent = uniqueArtists;
            document.getElementById('total-genres').textContent = uniqueGenres;
        }

        // Upload form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(uploadForm); // Simplified form data collection
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage('Song uploaded successfully!', 'success');
                    uploadForm.reset();
                    loadSongs();
                } else {
                    showMessage(result.error || 'Upload failed', 'error');
                }
            } catch (error) {
                showMessage('Upload failed. Please check the server connection.', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Upload Song';
            }
        });

        // Load and display songs
        async function loadSongs() {
            try {
                const response = await fetch('/api/songs');
                const songs = await response.json();
                const songsList = document.getElementById('songsList');
                if (songs.length === 0) {
                    songsList.innerHTML = '<div class="loading">No songs found.</div>';
                    updateStats([]);
                    return;
                }
                songsList.innerHTML = '';
                songs.forEach(song => {
                    const uploadDate = new Date(song.uploadDate).toLocaleString();
                    const songItem = document.createElement('div');
                    songItem.className = 'song-item';
                    
                    // *** CORRECTION 1: Pass song.file to previewSong, not a non-existent property ***
                    songItem.innerHTML = `
                        <div class="song-details">
                            <h4><i class="fa-solid fa-music"></i> ${song.title}</h4>
                            <p><i class="fa-solid fa-user"></i> <strong>Artist:</strong> ${song.artist}</p>
                            <p><i class="fa-solid fa-tags"></i> <strong>Genre:</strong> ${song.genre || 'Unknown'}</p>
                            <p><i class="fa-solid fa-calendar"></i> <strong>Uploaded:</strong> ${uploadDate}</p>
                        </div>
                        <div class="song-actions">
                            <button class="play-btn" onclick="previewSong('${song.file}', '${song.title}')">
                                <i class="fa-solid fa-play"></i> Preview
                            </button>
                            <button class="delete-btn" onclick="deleteSong('${song._id}', '${song.title}')">
                                <i class="fa-solid fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    songsList.appendChild(songItem);
                });
                updateStats(songs);
            } catch (error) {
                document.getElementById('songsList').innerHTML = 
                    '<div class="loading error"><i class="fa-solid fa-exclamation-triangle"></i> Error loading songs. Is the server running?</div>';
            }
        }

        // Preview song
        let previewAudio = null;
        // *** CORRECTION 2: Use the full file path provided by the server, not `/uploads/` ***
        function previewSong(filePath, title) {
            if (previewAudio) {
                previewAudio.pause();
            }
            previewAudio = new Audio(`/${filePath}`); // The path is correct now
            previewAudio.play().catch(error => {
                showMessage('Error playing preview. File may not exist.', 'error');
            });
            showMessage(`Playing preview: ${title}`, 'success');
            setTimeout(() => {
                if (previewAudio) previewAudio.pause();
            }, 30000);
        }

        // Delete song
        async function deleteSong(songId, songTitle) {
            if (!confirm(`Are you sure you want to delete "${songTitle}"? This cannot be undone.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/songs/${songId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage(`"${songTitle}" deleted successfully!`, 'success');
                    loadSongs();
                } else {
                    showMessage(result.error || 'Delete failed', 'error');
                }
            } catch (error) {
                showMessage('Delete failed. Please try again.', 'error');
            }
        }

        // Load songs when the page is ready
        loadSongs();
    </script>
</body>
</html>